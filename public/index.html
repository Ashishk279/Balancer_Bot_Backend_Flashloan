<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arbitrage Bot Live Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #6366f1; --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
      --dark: #1f2937; --gray: #6b7280; --gray-light: #f3f4f6; --white: #ffffff;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1); --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.15);
    }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px; color: var(--dark);
    }
    .container { max-width: 1500px; margin: 0 auto; }
    .header { background: var(--white); border-radius: 16px; padding: 30px; margin-bottom: 24px; box-shadow: var(--shadow-lg); }
    .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
    .header-title h1 { font-size: 28px; font-weight: 700; }
    .bot-icon { font-size: 36px; animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; }
    .stat-card { background: var(--gray-light); padding: 16px; border-radius: 12px; text-align: center; }
    .stat-value { font-size: 24px; font-weight: 700; color: var(--primary); }
    .stat-label { font-size: 12px; color: var(--gray); text-transform: uppercase; margin-top: 4px; }

    .connection-status { padding: 12px 24px; border-radius: 999px; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; }
    .status-connected { background: #d1fae5; color: #065f46; }
    .status-disconnected { background: #fee2e2; color: #991b1b; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: currentColor; animation: blink 1.5s infinite; }
    @keyframes blink { 50% { opacity: 0.4; } }

    .controls { background: var(--white); border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: var(--shadow-lg); display: flex; justify-content: space-between; flex-wrap: wrap; gap: 16px; }
    .filter-buttons { display: flex; gap: 12px; flex-wrap: wrap; }
    .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-outline { background: transparent; color: var(--primary); border: 2px solid var(--primary); }
    .btn-outline:hover, .btn-outline.active { background: var(--primary); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { background: #dc2626; }

    .opportunities-section { background: var(--white); border-radius: 16px; padding: 24px; box-shadow: var(--shadow-lg); }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--gray-light); }
    .section-title { font-size: 20px; font-weight: 700; }
    .opportunity-count { background: var(--primary); color: white; padding: 6px 16px; border-radius: 999px; font-weight: 700; font-size: 14px; }

    .opportunities-list { display: grid; gap: 20px; max-height: 900px; overflow-y: auto; padding-right: 8px; }
    .opportunities-list::-webkit-scrollbar { width: 8px; }
    .opportunities-list::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }

    .opportunity-card {
      border: 2px solid var(--gray-light); border-radius: 12px; padding: 24px;
      transition: all 0.3s; background: white;
    }
    .opportunity-card:hover { border-color: var(--primary); box-shadow: var(--shadow-lg); transform: translateY(-4px); }
    .opportunity-card.profitable { border-color: var(--success); background: linear-gradient(135deg, #f0fdf4 0%, white 100%); }

    .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid var(--gray-light); }
    .opportunity-type { padding: 6px 14px; border-radius: 999px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
    .type-v3_direct { background: #dbeafe; color: #1e40af; }

    .profit-info { text-align: right; }
    .profit-value { font-size: 28px; font-weight: 700; color: var(--success); }
    .profit-value.negative { color: var(--danger); }

    .trade-path {
      background: var(--gray-light); padding: 16px; border-radius: 12px; margin: 16px 0;
      display: flex; align-items: center; flex-wrap: wrap; gap: 12px; font-family: monospace; font-size: 14px;
    }
    .path-step { background: white; padding: 8px 12px; border-radius: 8px; min-width: 120px; text-align: center; }
    .arrow { font-size: 20px; color: var(--primary); }

    .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin: 16px 0; }
    .detail-item span:first-child { font-size: 12px; color: var(--gray); font-weight: 500; }
    .detail-item span:last-child { font-size: 14px; font-weight: 600; word-break: break-all; }

    .financial-summary {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;
      padding: 16px; background: var(--dark); border-radius: 12px; color: white;
    }
    .summary-item { text-align: center; }
    .summary-label { font-size: 11px; opacity: 0.8; margin-bottom: 4px; }
    .summary-value { font-size: 15px; font-weight: 700; }
    .positive { color: var(--success); }
    .negative { color: var(--danger); }

    .empty-state { text-align: center; padding: 80px 20px; color: var(--gray); }
    .empty-state-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }

    .toast {
      position: fixed; bottom: 24px; right: 24px; background: var(--dark); color: white;
      padding: 16px 24px; border-radius: 12px; box-shadow: var(--shadow-lg); display: flex; gap: 12px;
      animation: slideIn 0.4s ease-out; z-index: 1000;
    }
    @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-content">
        <div class="header-title">
          <span class="bot-icon">Robot</span>
          <div>
            <h1>Arbitrage Bot Live Dashboard</h1>
            <p style="color: var(--gray); font-size: 14px; margin-top: 4px;">Real-time Profit Opportunities</p>
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalOpportunities">0</div>
            <div class="stat-label">Total Detected</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="profitableCount">0</div>
            <div class="stat-label">Profitable</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalProfit">0</div>
            <div class="stat-label">Est. Total Profit (WETH)</div>
          </div>
        </div>
        <div id="connectionStatus" class="connection-status status-disconnected">
          <span class="status-dot"></span> Disconnected
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="filter-buttons">
        <button class="btn btn-outline active" data-filter="all" onclick="setFilter('all')">All</button>
        <button class="btn btn-outline" data-filter="v3_direct" onclick="setFilter('v3_direct')">V3 Direct</button>
        <button class="btn btn-outline" data-filter="profitable" onclick="setFilter('profitable')">Profitable Only</button>
      </div>
      <button class="btn btn-danger" onclick="clearOpportunities()">Clear All</button>
    </div>

    <div class="opportunities-section">
      <div class="section-header">
        <h2 class="section-title">Live Arbitrage Opportunities</h2>
        <span class="opportunity-count" id="displayedCount">0</span>
      </div>
      <div class="opportunities-list" id="opportunitiesList">
        <div class="empty-state">
          <div class="empty-state-icon">Chart</div>
          <div class="empty-state-text">Waiting for arbitrage opportunities...</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io();
    let opportunities = [];
    let currentFilter = 'all';

    socket.on('connect', () => {
      document.getElementById('connectionStatus').innerHTML = '<span class="status-dot"></span> Connected';
      document.getElementById('connectionStatus').className = 'connection-status status-connected';
      loadHistorical();
    });

    socket.on('new_opportunity', (opp) => {
      console.log('New opp:', opp);
      addOpportunity(opp);
      showToast('New Opportunity Detected!');
    });

    async function loadHistorical() {
      try {
        const res = await fetch('/api/all-opportunities');
        const data = await res.json();
        if (data.opportunities) {
          data.opportunities.forEach(addOpportunity);
          render();
        }
      } catch (e) { console.error(e); }
    }

    function addOpportunity(opp) {
      opportunities.unshift(opp);
      if (opportunities.length > 500) opportunities.pop();
      render();
    }

    function getProfit(opp) {
      return parseFloat(
        opp.actualProfit || opp.profit || opp.expectedProfit || opp.estimated_profit || 0
      );
    }

    function getProfitPercent(opp) {
      return opp.actualProfitPercent || 0;
    }

    function getToken(symbolField = "WETH") {
      try {
        const a = typeof opp.tokenA === 'string' ? JSON.parse(opp.tokenA) : opp.tokenA;
        const b = typeof opp.tokenB === 'string' ? JSON.parse(opp.tokenB) : opp.tokenB;
        return b?.symbol || a?.symbol || symbolField;
      } catch { return symbolField; }
    }

    function buildTradePath(opp) {
      if (opp.execution_payload?.path) {
        return opp.execution_payload.path.map((step, i) => {
          const dex = step.router === '0x1b81D678ffb9C0263b24A97847620C99d213eB14' ? 'PancakeV3' :
                     step.router === '0xE592427A0AEce92De3Edee1F18E0157C05861564' ? 'UniswapV3' :
                     step.router === '0x68b3465833fb72A70ecDF485E0e4C7bD8665Fc45' ? 'SushiV3' : 'Other';
          return `<div class="path-step">${i===0?'Buy':'Sell'} ${dex}<br><small>${step.fee/10}% fee</small></div>`;
        }).join('<span class="arrow">→</span>');
      }
      return `<div class="path-step">Buy ${opp.buyDex || 'Unknown'}</div>
              <span class="arrow">→</span>
              <div class="path-step">Sell ${opp.sellDex || 'Unknown'}</div>`;
    }

    function render() {
      const filtered = opportunities.filter(opp => {
        if (currentFilter === 'profitable') return getProfit(opp) > 0;
        if (currentFilter === 'v3_direct') return opp.type === 'v3_direct';
        return true;
      });

      document.getElementById('displayedCount').textContent = filtered.length;
      document.getElementById('totalOpportunities').textContent = opportunities.length;
      document.getElementById('profitableCount').textContent = opportunities.filter(o => getProfit(o) > 0).length;
      document.getElementById('totalProfit').textContent = 
        (opportunities.reduce((s,o) => s + getProfit(o), 0) / 1e18).toFixed(6);

      if (filtered.length === 0) {
        document.getElementById('opportunitiesList').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">No opportunities</div>
            <div class="empty-state-text">No matching opportunities</div>
          </div>`;
        return;
      }

      document.getElementById('opportunitiesList').innerHTML = filtered.map(opp => {
        const profit = getProfit(opp);
        const profitPercent = getProfitPercent(opp);
        const tokenSymbol = getToken();
        const isProfitable = profit > 0;

        return `
          <div class="opportunity-card ${isProfitable ? 'profitable' : ''}">
            <div class="card-header">
              <div>
                <span class="opportunity-type type-v3_direct">${opp.type || opp.strategy || 'Unknown'}</span>
                <div style="margin-top:8px; font-weight:600;">
                  ${opp.buyDex || 'Unknown'} → ${opp.sellDex || 'Unknown'}
                </div>
              </div>
              <div class="profit-info">
                <div style="font-size:12px; color:var(--gray);">Net Profit</div>
                <div class="profit-value ${isProfitable?'':'negative'}">
                  ${(profit / 1e18).toFixed(8)} ${tokenSymbol}
                  ${profitPercent ? `<br><small>+${(profitPercent*100).toFixed(4)}%</small>` : ''}
                </div>
              </div>
            </div>

            <div class="trade-path">
              ${buildTradePath(opp)}
            </div>

            <div class="details-grid">
              <div class="detail-item">
                <span>Amount In</span>
                <span>${(parseInt(opp.amountIn || 0) / 1e18).toFixed(6)} WETH</span>
              </div>
              <div class="detail-item">
                <span>Gas Cost</span>
                <span>${opp.gasCost ? (parseInt(opp.gasCost)/1e18).toFixed(6) : 'N/A'} WETH</span>
              </div>
              <div class="detail-item">
                <span>Tx Hash</span>
                <span style="font-size:12px;">${opp.txHash === '0x0' ? 'Pending' : opp.txHash || 'Pending'}</span>
              </div>
              <div class="detail-item">
                <span>Timestamp</span>
                <span>${new Date(opp.timestamp || Date.now()).toLocaleTimeString()}</span>
              </div>
            </div>

            <div class="financial-summary">
              <div class="summary-item">
                <div class="summary-label">Gross Profit</div>
                <div class="summary-value positive">+${(profit / 1e18).toFixed(8)}</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Gas Cost</div>
                <div class="summary-value negative">-${opp.gasCost ? (parseInt(opp.gasCost)/1e18).toFixed(6) : '0'}</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Net Profit %</div>
                <div class="summary-value ${isProfitable?'positive':'negative'}">
                  ${profitPercent ? (profitPercent*100).toFixed(4) + '%' : 'N/A'}
                </div>
              </div>
            </div>
          </div>`;
      }).join('');
    }

    function setFilter(f) {
      currentFilter = f;
      document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
      document.querySelector(`[data-filter="${f}"]`).classList.add('active');
      render();
    }

    function clearOpportunities() {
      if (confirm('Clear all opportunities?')) {
        opportunities = [];
        render();
      }
    }

    function showToast(msg) {
      const t = document.createElement('div');
      t.className = 'toast';
      t.innerHTML = `New ${msg}`;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 4000);
    }

    window.onload = () => {
      socket.on('connect', () => loadHistorical());
    };
  </script>
</body>
</html>